<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin Approvals</title>
    <style>
      :root {
        --bg: #f5f8fb;
        --panel: #fff;
        --text: #1f2937;
        --muted: #6b7280;
        --border: #d9e1ec;
        --ok: #166534;
        --danger: #991b1b;
      }

      * { box-sizing: border-box; }

      body {
        margin: 0;
        background: linear-gradient(180deg, #eff6ff, var(--bg));
        color: var(--text);
        font-family: 'IBM Plex Sans', 'Segoe UI', sans-serif;
      }

      .container {
        max-width: 900px;
        margin: 20px auto;
        padding: 16px;
      }

      .panel {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 14px;
      }

      .top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }

      h2 { margin: 0 0 12px; }

      .controls {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-bottom: 12px;
      }

      input, textarea {
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 8px 10px;
      }

      #token { min-width: 300px; }

      button {
        border: 1px solid var(--border);
        background: white;
        border-radius: 10px;
        padding: 8px 12px;
        cursor: pointer;
      }

      .item {
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 10px;
        margin-bottom: 10px;
        background: #fcfdff;
      }

      .meta { color: var(--muted); margin-top: 3px; font-size: 0.92rem; }
      .decision-row { margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap; }
      .approve { color: var(--ok); border-color: #86efac; }
      .decline { color: var(--danger); border-color: #fecaca; }
      .error { color: var(--danger); }

      @media (max-width: 720px) {
        #token { min-width: 0; width: 100%; }
        .decision-row button { width: 100%; }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="panel">
        <div class="top">
          <h2>Pending Approval Requests</h2>
          <a href="/chat/ui">Back to Chat UI</a>
        </div>

        <div id="build-info" class="meta" style="margin-bottom:10px;">Build: loading...</div>

        <div class="controls">
          <input id="token" type="password" placeholder="Admin token (x-api-token)" />
          <button id="save-token" type="button">Save token</button>
          <button id="refresh" type="button">Refresh</button>
          <label style="display:flex;align-items:center;gap:6px;">
            <input id="auto-refresh" type="checkbox" checked />
            Auto-refresh
          </label>
        </div>

        <div id="summary" class="meta">Loading...</div>
        <div id="pending" style="margin-top:10px;">Loading...</div>
      </div>
    </div>

    <script>
      const TOKEN_KEY = 'parking-admin-token';
      const tokenInput = document.getElementById('token');
      const saveTokenButton = document.getElementById('save-token');
      const refreshButton = document.getElementById('refresh');
      const autoRefresh = document.getElementById('auto-refresh');
      const summary = document.getElementById('summary');
      const buildInfo = document.getElementById('build-info');

      tokenInput.value = localStorage.getItem(TOKEN_KEY) || '';

      function authHeaders() {
        const token = localStorage.getItem(TOKEN_KEY) || '';
        return token ? { 'x-api-token': token } : {};
      }

      function hasToken() {
        return !!(localStorage.getItem(TOKEN_KEY) || '').trim();
      }

      function formatDate(value) {
        if (!value) return 'n/a';
        const date = new Date(value);
        return Number.isNaN(date.getTime()) ? value : date.toLocaleString();
      }

      saveTokenButton.addEventListener('click', () => {
        localStorage.setItem(TOKEN_KEY, tokenInput.value.trim());
        fetchPending();
      });

      refreshButton.addEventListener('click', () => fetchPending());

      async function fetchPending() {
        const container = document.getElementById('pending');
        if (!hasToken()) {
          summary.className = 'meta';
          summary.textContent = 'Provide admin token to view pending requests.';
          container.textContent = '';
          return;
        }
        try {
          const response = await fetch('/admin/requests', {
            headers: authHeaders(),
          });

          if (response.status === 401) {
            summary.textContent = 'Unauthorized. Provide valid admin token.';
            summary.className = 'error';
            container.textContent = '';
            return;
          }

          summary.className = 'meta';
          const requests = await response.json();
          const pending = Array.isArray(requests) ? requests : [];
          summary.textContent = `Pending requests: ${pending.length}`;

          if (pending.length === 0) {
            container.textContent = 'No pending requests.';
            return;
          }

          container.textContent = '';
          for (const item of pending) {
            const payload = item.payload || {};
            const requestId = item.request_id || '';

            const el = document.createElement('div');
            el.className = 'item';

            const reqLine = document.createElement('div');
            const reqStrong = document.createElement('strong');
            reqStrong.textContent = 'Request:';
            reqLine.appendChild(reqStrong);
            reqLine.appendChild(document.createTextNode(` ${requestId}`));
            el.appendChild(reqLine);

            const created = document.createElement('div');
            created.className = 'meta';
            created.textContent = `Created: ${formatDate(item.created_at)}`;
            el.appendChild(created);

            const name = document.createElement('div');
            name.className = 'meta';
            name.textContent = `Name: ${(payload.name || '').trim()} ${(payload.surname || '').trim()}`.trim();
            el.appendChild(name);

            const car = document.createElement('div');
            car.className = 'meta';
            car.textContent = `Car: ${payload.car_number || ''}`;
            el.appendChild(car);

            const period = document.createElement('div');
            period.className = 'meta';
            period.textContent = `Period: ${payload.reservation_period || ''}`;
            el.appendChild(period);

            const textarea = document.createElement('textarea');
            textarea.id = `note-${requestId}`;
            textarea.rows = 2;
            textarea.style.width = '100%';
            textarea.style.marginTop = '8px';
            textarea.placeholder = 'Optional admin note';
            el.appendChild(textarea);

            const row = document.createElement('div');
            row.className = 'decision-row';

            const approveBtn = document.createElement('button');
            approveBtn.className = 'approve';
            approveBtn.dataset.id = requestId;
            approveBtn.dataset.approved = 'true';
            approveBtn.textContent = 'Approve';
            row.appendChild(approveBtn);

            const declineBtn = document.createElement('button');
            declineBtn.className = 'decline';
            declineBtn.dataset.id = requestId;
            declineBtn.dataset.approved = 'false';
            declineBtn.textContent = 'Decline';
            row.appendChild(declineBtn);

            el.appendChild(row);
            container.appendChild(el);
          }
        } catch (_error) {
          summary.className = 'error';
          summary.textContent = 'Failed to load pending requests.';
        }
      }

      async function sendDecision(requestId, approved) {
        const noteEl = document.getElementById(`note-${requestId}`);
        const noteText = noteEl ? noteEl.value.trim() : '';

        const response = await fetch('/admin/decision', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
          body: JSON.stringify({
            request_id: requestId,
            approved,
            notes: noteText || (approved ? 'Approved via admin UI' : 'Declined via admin UI'),
          }),
        });

        if (!response.ok) {
          throw new Error('Decision request failed');
        }
      }

      document.addEventListener('click', async (event) => {
        const button = event.target.closest('button[data-id]');
        if (!button) return;

        const requestId = button.dataset.id;
        const approved = button.dataset.approved === 'true';

        try {
          await sendDecision(requestId, approved);
          await fetchPending();
        } catch (_error) {
          alert('Unable to submit decision. Verify token and retry.');
        }
      });

      fetch('/version')
        .then((resp) => resp.json())
        .then((data) => {
          const sha = (data?.git_sha || '').toString().slice(0, 12);
          const when = (data?.build_time || '').toString();
          const env = (data?.app_env || '').toString();
          const parts = [];
          if (sha) parts.push(`sha ${sha}`);
          if (when) parts.push(when);
          if (env) parts.push(env);
          buildInfo.textContent = parts.length ? `Build: ${parts.join(' | ')}` : 'Build: unknown';
        })
        .catch(() => {
          buildInfo.textContent = 'Build: unavailable';
        });

      fetchPending();
      setInterval(() => {
        if (autoRefresh.checked && hasToken()) {
          fetchPending();
        }
      }, 3000);
    </script>
  </body>
</html>

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin Approvals</title>
    <style>
      body { font-family: Arial, sans-serif; margin: 20px; }
      .item { border: 1px solid #ddd; padding: 10px; margin-bottom: 8px; }
      .meta { color: #555; margin-top: 4px; }
      button { margin-right: 8px; }
      #token { min-width: 300px; }
    </style>
  </head>
  <body>
    <h2>Pending Approval Requests</h2>
    <p><a href="/chat/ui">Back to Chat UI</a></p>
    <p>
      Admin token:
      <input id="token" type="password" placeholder="Optional: x-api-token" />
      <button id="save-token" type="button">Save token</button>
    </p>
    <div id="pending">Loading...</div>

    <script>
      const TOKEN_KEY = 'parking-admin-token';
      const tokenInput = document.getElementById('token');
      const saveTokenButton = document.getElementById('save-token');

      tokenInput.value = localStorage.getItem(TOKEN_KEY) || '';

      function authHeaders() {
        const token = localStorage.getItem(TOKEN_KEY) || '';
        return token ? { 'x-api-token': token } : {};
      }

      saveTokenButton.addEventListener('click', () => {
        localStorage.setItem(TOKEN_KEY, tokenInput.value.trim());
        fetchPending();
      });

      async function fetchPending() {
        const container = document.getElementById('pending');
        try {
          const response = await fetch('/admin/requests', {
            headers: authHeaders(),
          });

          if (response.status === 401) {
            container.textContent = 'Unauthorized. Provide valid admin token.';
            return;
          }

          const requests = await response.json();
          const pending = Array.isArray(requests) ? requests : [];

          if (pending.length === 0) {
            container.textContent = 'No pending requests.';
            return;
          }

          container.innerHTML = '';
          for (const item of pending) {
            const el = document.createElement('div');
            el.className = 'item';
            el.innerHTML = `
              <div><strong>Request:</strong> ${item.request_id}</div>
              <div class="meta">Name: ${item.payload.name} ${item.payload.surname}</div>
              <div class="meta">Car: ${item.payload.car_number}</div>
              <div class="meta">Period: ${item.payload.reservation_period}</div>
              <div style="margin-top: 8px">
                <button data-id="${item.request_id}" data-approved="true">Approve</button>
                <button data-id="${item.request_id}" data-approved="false">Decline</button>
              </div>
            `;
            container.appendChild(el);
          }
        } catch (_error) {
          container.textContent = 'Failed to load pending requests.';
        }
      }

      async function sendDecision(requestId, approved) {
        const response = await fetch('/admin/decision', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
          body: JSON.stringify({
            request_id: requestId,
            approved,
            notes: approved ? 'Approved via admin UI' : 'Declined via admin UI',
          }),
        });

        if (!response.ok) {
          throw new Error('Decision request failed');
        }
      }

      document.addEventListener('click', async (event) => {
        const button = event.target.closest('button[data-id]');
        if (!button) return;

        const requestId = button.dataset.id;
        const approved = button.dataset.approved === 'true';

        try {
          await sendDecision(requestId, approved);
          await fetchPending();
        } catch (_error) {
          alert('Unable to submit decision.');
        }
      });

      fetchPending();
      setInterval(fetchPending, 2000);
    </script>
  </body>
</html>

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Parking Chatbot UI</title>
    <style>
      body { font-family: Arial, sans-serif; margin: 20px; }
      #messages { border: 1px solid #ddd; min-height: 280px; padding: 12px; margin-bottom: 12px; overflow-y: auto; }
      .msg { margin: 8px 0; }
      .user { font-weight: bold; }
      .bot { color: #1d4ed8; }
      form { display: flex; gap: 8px; }
      input { flex: 1; padding: 8px; }
      button { padding: 8px 14px; }
    </style>
  </head>
  <body>
    <h1>Parking Chatbot</h1>
    <p><a href="/admin/ui">Open Admin Approval UI</a></p>

    <div id="messages"></div>

    <form id="chat-form">
      <input id="message" type="text" placeholder="Type your message" required />
      <button type="submit">Send</button>
    </form>

    <script>
      const THREAD_ID_KEY = 'parking-chat-thread-id';
      const form = document.getElementById('chat-form');
      const input = document.getElementById('message');
      const messages = document.getElementById('messages');

      function generateThreadId() {
        return `${Date.now()}-${Math.random().toString(16).slice(2)}`;
      }

      function getThreadId() {
        let threadId = localStorage.getItem(THREAD_ID_KEY);
        if (!threadId) {
          threadId = generateThreadId();
          localStorage.setItem(THREAD_ID_KEY, threadId);
        }
        return threadId;
      }

      function append(role, text) {
        const div = document.createElement('div');
        div.className = `msg ${role}`;
        div.textContent = `${role === 'user' ? 'You' : 'Bot'}: ${text}`;
        messages.appendChild(div);
        messages.scrollTop = messages.scrollHeight;
      }

      append('bot', 'Hello! Ask for parking info or start a booking request.');

      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        const message = input.value.trim();
        if (!message) return;

        append('user', message);
        input.value = '';

        try {
          const response = await fetch('/chat/message', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message, thread_id: getThreadId() }),
          });

          const data = await response.json();
          if (!response.ok) {
            append('bot', `Error: ${data.detail || 'Request failed'}`);
            return;
          }

          if (data.thread_id) {
            localStorage.setItem(THREAD_ID_KEY, data.thread_id);
          }
          append('bot', data.response || '(empty response)');
        } catch (error) {
          append('bot', `Network error: ${error.message}`);
        }
      });
    </script>
  </body>
</html>
